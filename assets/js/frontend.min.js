!function(t){"use strict";if(void 0===bpmffData)return void console.error("BPMFF: bpmffData is not defined");const e={config:{ajaxUrl:bpmffData.ajaxUrl,nonce:bpmffData.nonce,displayCount:parseInt(bpmffData.displayCount)||3,tooltipDelay:500,cacheTimeout:3e5},cache:new Map,init:function(){this.bindEvents()},bindEvents:function(){t(document).on("mouseenter","[data-bpmff-user]",this.handleMemberHover.bind(this)),t(document).on("click",".bpmff-view-all",this.openModal.bind(this)),t(document).on("click",".bpmff-modal-close",this.closeModal.bind(this)),t(document).on("click",".bpmff-modal-overlay",this.closeModalOnOverlay.bind(this))},handleMemberHover:function(e){const o=t(e.currentTarget),i=o.data("bpmff-user");i&&(this.hoverTimeout&&clearTimeout(this.hoverTimeout),this.hoverTimeout=setTimeout(()=>{this.loadMutualFriends(i,o)},this.config.tooltipDelay),o.one("mouseleave",()=>{clearTimeout(this.hoverTimeout)}))},loadMutualFriends:function(e,o){const i=`mutual_${e}`,s=this.cache.get(i);s&&Date.now()-s.timestamp<this.config.cacheTimeout?this.showTooltip(o,s.data):(this.showLoadingTooltip(o),t.ajax({url:this.config.ajaxUrl,type:"POST",data:{action:"bpmff_get_mutual_friends",nonce:this.config.nonce,target_user_id:e,display_count:this.config.displayCount,format:"tooltip"},success:t=>{t.success?(this.cache.set(i,{data:t.data,timestamp:Date.now()}),this.showTooltip(o,t.data)):this.showErrorTooltip(o,t.data.message)},error:()=>{this.showErrorTooltip(o,"Failed to load mutual friends")}}))},showTooltip:function(e,o){t(".bpmff-tooltip").remove(),0!==o.count&&(t("body").append(t(o.html)),setTimeout(()=>{t(".bpmff-tooltip").addClass("bpmff-tooltip-visible")},10),e.one("mouseleave",()=>{t(".bpmff-tooltip").removeClass("bpmff-tooltip-visible"),setTimeout(()=>{t(".bpmff-tooltip").remove()},300)}),t(".bpmff-tooltip").on("mouseenter",()=>{e.off("mouseleave")}),t(".bpmff-tooltip").on("mouseleave",()=>{t(".bpmff-tooltip").removeClass("bpmff-tooltip-visible"),setTimeout(()=>{t(".bpmff-tooltip").remove()},300)}))},showLoadingTooltip:function(e){t(".bpmff-tooltip").remove();const o=t('<div class="bpmff-tooltip bpmff-loading" role="status"><div class="bpmff-spinner"></div><span>'+bpmffData.i18n.loading+"</span></div>");this.positionTooltip(o,e),t("body").append(o),setTimeout(()=>{o.addClass("bpmff-tooltip-visible")},10)},showErrorTooltip:function(e,o){t(".bpmff-tooltip").remove();const i=t('<div class="bpmff-tooltip" role="alert"><div class="bpmff-error-message">'+o+"</div></div>");this.positionTooltip(i,e),t("body").append(i),setTimeout(()=>{i.addClass("bpmff-tooltip-visible")},10),setTimeout(()=>{i.removeClass("bpmff-tooltip-visible"),setTimeout(()=>{i.remove()},300)},3e3)},positionTooltip:function(e,o){const i=o.offset(),s=o.outerWidth(),l=o.outerHeight(),a=e.outerWidth(),p=e.outerHeight(),c=t(window).width(),f=t(window).height(),u=t(window).scrollTop();let h,m,d=bpmffData.tooltipPosition||"auto";"auto"===d&&(d=f-(i.top-u+l)>p?"bottom":"top");switch(d){case"bottom":h=i.top+l+10,m=i.left+s/2-a/2,e.addClass("bpmff-tooltip-bottom");break;case"left":h=i.top+l/2-p/2,m=i.left-a-10,e.addClass("bpmff-tooltip-left");break;case"right":h=i.top+l/2-p/2,m=i.left+s+10,e.addClass("bpmff-tooltip-right");break;default:h=i.top-p-10,m=i.left+s/2-a/2,e.addClass("bpmff-tooltip-top")}m=Math.max(10,Math.min(m,c-a-10)),h=Math.max(u+10,h),e.css({top:h,left:m})},openModal:function(e){e.preventDefault();const o=t(e.currentTarget).data("user-id");this.loadModalContent(o,1)},loadModalContent:function(e,o){o=o||1,t.ajax({url:this.config.ajaxUrl,type:"POST",data:{action:"bpmff_get_all_mutual_friends",nonce:this.config.nonce,target_user_id:e,page:o},success:t=>{t.success&&this.showModal(e,t.data)},error:()=>{alert("Failed to load mutual friends")}})},showModal:function(e,o){t(".bpmff-modal-overlay").remove();const i=t('<div class="bpmff-modal-overlay" role="dialog" aria-modal="true"></div>'),s=t("<div class='bpmff-modal'></div>"),l=t('<div class="bpmff-modal-header"><h3>Mutual Friends</h3><button type="button" class="bpmff-modal-close" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>'),a=t('<div class="bpmff-modal-body"><div class="bpmff-modal-content">'+o.html+"</div></div>"),p=t('<div class="bpmff-modal-footer"><div class="bpmff-modal-pagination"></div></div>');if(o.total_pages>1){let t="";for(let i=1;i<=o.total_pages;i++)t+=i===o.page?'<span class="current">'+i+"</span>":'<a href="#" data-page="'+i+'" data-user-id="'+e+'">'+i+"</a>";p.find(".bpmff-modal-pagination").html(t)}s.append(l).append(a).append(p),i.append(s),t("body").append(i),setTimeout(()=>{i.addClass("bpmff-modal-visible")},10),i.on("click",".bpmff-modal-pagination a",t=>{t.preventDefault();const o=t(t.currentTarget).data("page");this.loadModalContent(e,o)})},closeModal:function(){const e=t(".bpmff-modal-overlay");e.removeClass("bpmff-modal-visible"),setTimeout(()=>{e.remove()},300)},closeModalOnOverlay:function(o){t(o.target).hasClass("bpmff-modal-overlay")&&this.closeModal()}};t(document).ready(()=>{e.init()}),window.BPMFF=e}(jQuery);
